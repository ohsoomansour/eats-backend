/* eslint-disable prettier/prettier */
import { ApolloDriver } from '@nestjs/apollo';
import * as Joi from 'joi';
import { Module } from '@nestjs/common';
import { GraphQLModule } from '@nestjs/graphql';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ConfigModule } from '@nestjs/config';
import { UsersModule } from './users/uers.module';
import { User } from './users/entities/user.entity';
import { JwtModule } from './jwt/jwt.module';
import { Verification } from './users/entities/verification.entity';
import { MailModule } from './mail/mail.module';
import { Restaurant } from './restaurants/entities/restaurant.entity';
import { Category } from './restaurants/entities/category.entity';
import { RestaurantsModule } from './restaurants/restaurants.module';
import { AuthModule } from './auth/auth.module';
import { Dish } from './restaurants/entities/dish.entity';
import { OrdersModule } from './orders/orders.module';
import { Order } from './orders/entities/order.entity';
import { OrderItem } from './orders/entities/order-item.entity';
import { CommonModule } from './common/common.module';
import { PaymentModule } from './payment/payment.module';
import { Payment } from './payment/entities/payment.entity';
import { ScheduleModule } from '@nestjs/schedule';
import { UploadsModule } from './uploads/uploads.module';
import { Context } from 'apollo-server-core';
/*#Ô∏è‚É£1.0 Appllo Server Setup
 1.ÏÑ§Ïπò: npm i @nestjs/graphql @nestjs/apollo graphql apollo-server-express
    > Ïù¥Ìï¥:  graphql & appllo server Í∏∞Î∞òÌïòÏó¨ ÏûëÎèô 
 2. AppModuleÏùÄ main.tsÎ°ú importÎêòÎäî Ïú†ÏùºÌïú Î™®Îìà    
 3. forRoot
  - 'Î£®Ìä∏ Î™®Îìà'ÏùÑ ÏÑ§Ï†ïÌïòÎäî Í≤É Ïó¨Í∏∞ÏÑúÎäî ‚≠êGraphModuleÏù¥ Ïù¥Îã§ 
    > Error: Appllor Server requires either an existing 'schema', modules or 'typeDefs'
    > ErrorÏù¥Ïú†: graphqlÏù¥ dataÏùò shapeÏùÑ ÎØ∏Î¶¨ ÏïåÍ≥† ÏûàÏñ¥Ïïº ÌïòÍ∏∞ ÎïåÎ¨∏
        ‚≠êgql`
           (Schema Defination Language)
          1)query dataÏóê ÎåÄÌï¥ÏÑúÎèÑ ÌïòÎÇòÏùò Ïñ∏Ïñ¥Î•º Ïì∞Í≥† dataÏùò shapeÏùÑ ÏÑ§Î™ÖÌïòÎäî Îç∞ÏóêÎèÑ Í∞ôÏùÄ Ïñ∏Ïñ¥Î•º Ïì¥Îã§Îäî Í≤É  
          2)Ïö∞Î¶¨ dataÏùò typeÏóê ÎåÄÌï¥ graphqlÌïúÌÖå ÏÑ§Î™ÖÌï¥Ï£ºÍ∏∞ ÏúÑÌï¥ÏÑú 
          3)Query root type must be provided. 
  #Ô∏è‚É£1.1 Our First Resolver
  1. The GraphQLModule can be configured to use Apollo server "ÏïÑÌè¥Î°ú ÏÑúÎ≤Ñ Í∏∞Î∞òÏúºÎ°ú ÎèôÏûëÌïúÎã§ "
  2. https://www.apollographql.com/docs/apollo-server/api/apollo-server
    > API Reference: apollo-server ÏóêÏÑú ÏÑ∏ÌåÖ ÌôïÏù∏

  3. Quick start - üî∑Code first
   - GraphQLModule.forRoot<ApolloDriverConfig>({
    ‚≠êdriver: ApolloDriver,
    ‚≠êautoSchemaFile: join(process.cwd(), 'src/schema.gql'),  "ÏûêÎèôÏúºÎ°ú ÎÇ† ÏúÑÌï¥ 'schema'Î•º ÏÉùÏÑ± Ìï¥Ï§ÄÎã§ "
    }),                   


    > üö®Missing "driver" option > ‚≠êdriver: ApolloDriver,
    > üö®ÏóêÎü¨ Î©îÏÑ∏ÏßÄ: Query root type must be provided
      - Schema generation error (code-first approach)
      - ÏõêÏù∏:
       [GraphQL > API Reference - ApploServer Ï∞∏Ï°∞]
        Document or documents that represent your server's GraphQL schema
        ,generated by applying the gql tag to valid Schema Definition Language (SDL) strings. 
        üîπconst typeDefs = gql`
          type Query {}
        `
        üîπconst server = new ApolloServer({typeDefs, resolvers});
        ‚≠êÏö∞Î¶¨Ïùò GraphQL Î™®ÎìàÏù¥  Query root typeÏôÄ resolverÎ•º Ï∞æÍ≥† ÏûàÎã§ 
        > npx nest g mo restaurants 
        > [resaurants.module.ts] ÏÉùÏÑ±Ïù¥ Îê†Í±∞Í≥†
          @Module({
          ‚≠êproviders: [RestaurantResolver],
          })
          export class RestaurantsModule {}  
        > [restaurants.resolver.ts] ÌååÏùº ÏßÅÏ†ë ÎßåÎì§Í≥† ‚≠ê@Resolver & @Query ÏûëÏÑ± 
        > [schema.gql]ÌååÏùº ÏÉùÏÑ± ÌõÑ ÏÇ≠Ï†úÏãú, ‚≠êautoSchemaFile:true;
    4.http://localhost:3000/graphql 
      > playground & SCHEMAÍ∞Ä ÏûàÎã§ 
         
 */
/*#Ô∏è‚É£2.0 TypeORM and PostgreSQL
  1. üõ∏TypeScript & NesJSÏóêÏÑú DataBaseÏôÄ ÌÜµÏã†ÌïòÍ∏∞ ÏúÑÌï¥ÏÑú > ‚≠êORM ÏÇ¨Ïö©
  2. typeorm.io/#/ > TYPE ORMÏùÑ Ïì∞Î©¥ ÌÉÄÏûÖÏä§ÌÅ¨Î¶ΩÌä∏Ïùò Ï¢ãÏùÄ Ï†êÏùÑ Î™®Îëê Ïù¥Ïö©
  3. TypeORM: Object Relational Mapping Í∞ùÏ≤¥ Í¥ÄÍ≥Ñ Îß§Ìïë 
   > SQLÎ¨∏ÏùÑ Ïì∞Îäî ÎåÄÏã†Ïóê ÏΩîÎìúÎ•º Ïç®ÏÑú ÏÉÅÌò∏ÏûëÏö©ÏùÑ Ìï† Ïàò ÏûàÎã§
   > ÌÉÄÏûÖÏä§ÌÅ¨Î¶ΩÌä∏ ÏΩîÎìú > TYPE ORM üõ∏ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏôÄ ÏÉÅÌò∏ÏûëÏö© 

  4.PostgreSQL: https://www.postgresql.org/ 
  üìÑ 4-1)ÏÑ§Ïπò
   > C:\Program Files\PostgreSQL\11 > pw:2848 > port:3000 
   > postgresql-12.12-1-windows-x64.exe --install_runtimes 0
   >‚≠êPostgreSQL 11.2 ÏÑ§ÏπòÎ∞©Î≤ï https://source-factory.tistory.com/22
   >‚≠êPostgreSQL 11.2  https://get.enterprisedb.com/postgresql/postgresql-11.2-1-windows-x64.exe
   > ÏÑ§ÏπòÍ≤ΩÎ°ú: C:\Program Files\PostgreSQL\11\data
   >  port:5432

  üìÑ 4-2)‚≠êÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ Î∞©Î≤ï
   > pgAdmin Ïó¥Í∏∞ >  > [Add New server]
      - ‚≠ê[connection] > hostname: localhost > port:5432(default) > Maintenanace database: postgres(default) 
      - Username:postgres(default) 
      > password:284823
   > DatabaseÏö∞ÌÅ¥Î¶≠, Create > Database: üîπnuber-eats > Owner: ohsoomansour
   > ‚≠êSQL: Create DATABASE "nuber-eats", OWNER = ohsoomansour 
   > Ïã§ÌñâÎêúÎã§Îäî Í≤ÉÎßå ÏïåÍ≥† ÎÑòÏñ¥Í∞ê
   >

  5. TypeORM
   - ÏùòÎØ∏: TypeScriptÎ°ú ÏûëÏÑ±Îêú Í¥ÄÍ≥ÑÌòï Îß§Ìçº ÎùºÏù¥Î∏åÎü¨Î¶¨ SQLÏùÑ Ïûë
   > docs.nestjs.com/techniques/database
   > npm > https://www.npmjs.com/package/typeorm
   > npm install typeorm --save
   > ‚≠ênpm install reflect-metadata --save
   > npm install @types/node --save-dev
   > npm install pg --save
   > npm install --save @nestjs/typeorm typeorm pg
   > npm install typeorm --save
   > Install a database driver: npm install pg --save

  6. ÌîÑÎ°úÏ†ùÌä∏ & Ïô∏Î∂ÄDB(PostgreSQL) Ïó∞Í≤∞    
   - ÏΩîÎìúÏóê ÏßÅÏ†ëÏì∞Í±∞ÎÇò ormconfig.jsonÏù¥ÎùºÎäî ÌååÏùºÏóê Ïì∞Îäî Î∞©Î≤ï 
   - port:  5432(PostgreSQL)
    
   - password: localhostÎ©¥ ÏïàÏç®ÎèÑÎê®, ohsoomansour(2848)
   - synchronize:true, "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Î•º ÎÑàÏùò Î™®ÎìàÏùò ÌòÑÏû¨ÏÉÅÌÉúÎ°ú ÎßàÏù¥Í∑∏ÎûòÏù¥ÏÖò(Ïù¥Îèô) ÌïúÎã§Îäî Îúª "
   - logging: true, "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Î¨¥Ïä® ÏùºÏù¥ ÏùºÏñ¥ÎÇòÎäîÏßÄ ÏΩòÏÜîÏóê ÌëúÏãú" 
    > ‚≠ênpm run start:dev "ÏïÑÎûòÏùò SQLÏΩîÎìú Î≥¥Ïù¥Î©¥ ÏÑ±Í≥µ"
    query: SELECT * FROM current_schema()
    query: SELECT version();
    query: START TRANSACTION
    query: SELECT * FROM "information_schema"."tables" WHERE "table_schema" = 'public' AND "table_name" = 'typeorm_metadata'
    query: COMMIT

  7. üö®Error: listen EADDRINUSE: address already in use :::3000 +5ms
   - Ïù¥ÎØ∏ 3000Î≤à Ìè¨Ìä∏Í∞Ä ÏÇ¨Ïö©Ï§ëÏù¥Îã§ 
   - Ìï¥Í≤∞Î∞©Ïïà1. ÏÑúÎ≤ÑÎ•º Îã§ ÎÅÑÍ±∞ÎÇò Ìï¥Í≤∞Î∞©Ïïà2.  Î∞±Ïï§Îìúport: 4000 5000 8000 
  
   */
/*#Ô∏è‚É£2.4 ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº(.env)ÏùÑ node.jsÏóêÏÑú Ïù¥Ïö©ÌïòÎäî Î∞©Î≤ïÏùÄ
üìÑTS(npm): https://www.npmjs.com/package/dotenv
> ‚≠êdotenvÎùºÏù¥Î∏åÎü¨Î¶¨Îäî .env ÌååÏùºÏóêÏÑú ÌôòÍ≤Ω Î≥ÄÏàòÎ•º Î°úÎìúÌïòÎäîÎç∞
> [node.js] node.jsÏóêÏÑú üîπ'ÌôòÍ≤ΩÎ≥ÄÏàò'Ïóê Ï†ëÍ∑ºÌï† ÎïåÎäî üîπ'process.env'ÎùºÎäî 'ÎÇ¥Ïû• ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ Í∞ùÏ≤¥'Î•º ÏÇ¨Ïö© 
  - processÎäî Ï†ÑÏó≠Í∞ùÏ≤¥ Î≥ÑÎèÑÎ°ú ÏûÑÌè¨Ìä∏ Î™®ÎìàÏù¥ ÏóÜÏúºÎ©∞ Ïñ¥ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ïñ¥ÎîîÏóêÏÑúÎì† Ï†ëÍ∑ºÏù¥ Í∞ÄÎä•Ìï®
  
üî∑ÏòàÏãú ‚≠ê"db Î™®ÎìàÏù¥ env.process Î•º ÌÜµÌï¥ ÌôòÍ≤ΩÎ≥ÄÏàò Í∞ùÏ≤¥Î•º ÏñªÍ≥†  >> ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞"
  const db = require('db') 
   db.connect({
     host: process.env.DB_USER
     username: process.env.DB_USER,
     password: process.env.DB_PASS
       })
  *equire(): "Î™®ÎìàÏùÑ Î∂àÎü¨Ïò¥"
  *connect() Ìï®ÏàòÎäî ÏÑúÎ≤ÑÏóê ÎåÄÌïú Ïó∞Í≤∞ÏùÑ ÏÑ§Ï†ïÌïòÎäî Îç∞ ÏÇ¨Ïö©
  *ÌôòÍ≤ΩÎ≥ÄÏàò: Ïñ¥Îäê directoryÏóêÏÑúÎì†ÏßÄ ÌîÑÎ°úÍ∑∏Îû®ÏùÑ Ïã§Ìñâ Ìï† ÏàòÏûàÍ≤å ÎßåÎì¨ ‚Äªhttps://velog.io/@psj0810/%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98%EB%9E%80

 üìÑnestjsÎ∞©Î≤ï: "üìÅconfiguration mudule Ïù¥ÎûÄÍ±∏ Í∞ÄÏßÄÍ≥† ÏûàÏùå" ‚Äªhttps://docs.nestjs.com/techniques/configuration
 1. ÏÑ§Ïπò: npm i --save @nestjs/config 
  - The @nestjs/config package internally uses dotenv
 2.ConfigModule.forRoot({
    isGlobal:true, "Ïö∞Î¶¨ appÏùò Ïñ¥ÎîîÏÑúÎÇò 'config Î™®Îìà'Ïóê Ï†ëÍ∑ºÌï† Ïàò ÏûàÎã§Îäî Í±∞ "
    envFilePath: ".env",  "Ïö∞Î¶¨ ÌååÏùºÏóêÏÑú .env ÌååÏùºÏùÑ ÏùΩÎäîÎã§ "
    ignoreEnvFile: process.env.NODE_ENV === 'prod' "production ÌôòÍ≤ΩÏùº ÎïåÎäî configModuleÏù¥ 'ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº'ÏùÑ Î¨¥Ïãú "
    > ÌôòÍ≤ΩÎ≥ÄÏàòÎäî Îã§Î•∏ Î∞©Î≤ïÏúºÎ°ú ÏñªÏùÑÍ±∞ÏûÑ 
  })
  > [node.js, NODE_ENV Í∞íÏùÑ ÏÑ§Ï†ï]
    ‚≠êNODE_ENV(ÌôòÍ≤ΩÎ≥ÄÏàò)Îäî ÌòÑÏû¨ Îã®Í≥ÑÎ•º Ï†ïÌï¥Ï£ºÎäî 'ÏÉÅÏàò'ÏùºÎøê: devÎã®Í≥Ñ ? Ïä§ÌÖåÏù¥Ïßï Îã®Í≥Ñ ? ÌîÑÎ°úÎçïÏÖòÎã®Í≥Ñ ? 
      > Í∞Å ÌîÑÎ†àÏûÑÏõåÌÅ¨(ÎùºÏù¥Î∏åÎü¨Î¶¨)ÎßàÎã§ ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùºÏùÑ Î∂àÎü¨Ïò§Îäî ÏàúÏÑúÍ∞Ä Í≥µÏãùÎ¨∏ÏÑúÏóê ÏûàÏùå 
        - OSÍ∞Ä windowÏùº Í≤ΩÏö∞, set NODE_ENV = production  
        - OSÍ∞Ä Mac OS X Í∏∞Ï§Ä, export NODE_ENV = production
         
  > ÌôòÍ≤ΩÏùÑ ÏÑ§Ï†ïÌïòÎ†§Î©¥ npm i cross-env 
   - ‚≠êcross-env Ìå®ÌÇ§ÏßÄÎ•º ÏÇ¨Ïö©ÌïòÎ©¥ ÎèôÏ†ÅÏúºÎ°ú process.env ÌôòÍ≤ΩÎ≥ÄÏàò(Í∞ÄÏÉÅÎ≥ÄÏàò)Î•º ÏÑ§Ï†ïÌï† Ïàò ÏûàÍ≤å Ìï¥Ï§ÄÎã§ (OSÏóê Í¥ÄÍ≥ÑÏóÜÏù¥)
  > [package.json] start:dev Ïª§Îß®ÎìúÎ•º ÏûÖÎ†•ÌïòÎ©¥, .env.devÎ°ú ÏÑ§Ï†ïÌïòÍ≥†Ïã∂Îã§ 
                   testÎÇò test:wathÎ•º ÏûÖÎ†•ÌïòÎ©¥, .env.testÎ°ú ÏÑ§Ï†ïÌïòÍ≥† Ïã∂Îã§ 
                   start Ïª§Îß®ÎìúÎ•º ÏûÖÎ†•ÌïòÎ©¥, env.proÎ°ú ÏÑ§Ï†ïÌïòÍ≥† Ïã∂Îã§ 

  > [package.json] "start:dev": "cross-env NODE_ENV=dev nest start --watch",
    - npm run start:dev (ÌÑ∞ÎØ∏ÎÑê) -> "(Î™ÖÏãúÎêú)'cross-env'Î•º Î∂àÎü¨ÏÑú NODE_ENVÎùºÎäî ‚≠êÌôòÍ≤ΩÎ≥ÄÏàò(Í∞ÄÏÉÅÎ≥ÄÏàò)Î•º devÎùºÍ≥† ÏßÄÏ†ï"
  > .gitnoreÏóê .envÎ•º Ï∂îÍ∞Ä 
   # dotenv environment variable files
    .env
    .env.dev
    .env.test
   
  */
/*#Ô∏è‚É£2.6 Validating ConfigService
1. npm i joi
  > validationSchema: "Ïä§ÌÇ§ÎßàÏùò Ïú†Ìö®ÏÑ± ÌôïÏù∏Ïù¥ÎùºÍ≥† ÏÉùÍ∞ÅÌïòÎ©¥ Îê®"
*/
/*#Ô∏è‚É£3.3Recap
  ‚≠êTypeOrmModule.forRoot({ 
      entities: [Restaurant]
      logging: true  
    })
   > TypOrmModuleÏù¥ Restaurant entityÎ•º Í∞ÄÏßÄÍ≥† ÏûàÍ∏∞ ÎïåÎ¨∏Ïóê' RestaurantÏù¥ DB'Í∞Ä ÎêòÎäî Í±∞Îã§
   > logging: true "DBÏóêÏÑú ÎèåÏïÑÍ∞ÄÎäî Î™®Îì† Î°úÍ∑∏Îì§ÏùÑ ÌôïÏù∏ "
*/
/*#Ô∏è‚É£üìÉforRoot: https://docs.nestjs.com/modules
  üî¥1. GraphQLModule.forRoot Î©îÏÑúÎìúÏóê Ïù∏ÏàòÎ°ú contextÎ•º ÎÑ£ÏúºÎ©¥ Ïñ¥ÎñªÍ≤å Ïù∏ÏãùÏù¥ ÎêòÎäî Í±¥Í∞ÄÏöî ?
          forRootÎ©îÏÑúÎìúÏùò Ïù¥Ìï¥Í∞Ä Î∂ÄÏ°±Ìï¥ÏÑú Ïù¥Ìï¥Í∞Ä Ïûò Ïïà ÎêòÎäîÍ±∞ Í∞ôÏäµÎãàÎã§
          GraphQLModule.forRoot({
          driver: ApolloDriver,
          autoSchemaFile: true,
          context:({ req }) => ({user: req['user'] })
        }),
2. ÏïÑÎãàÎ©¥ nestjsÏùò Î¨∏Î≤ï Í∑∏ÎåÄÎ°ú Ïù¥Ìï¥Î•º Ìï¥Ïïº ÌïòÎäî Í±¥Í∞ÄÏöî ?
 >> ‚úÖnico:  Yes, this is how you configure a module on NestJS
*/
/*#Ô∏è‚É£9.0 Setup part One
1. where do we set NODE_ENV as 'test' ? üìÑhttps://jestjs.io/docs/en/environment-variables
 > Set to 'test' if it's not already set to something else.
2. Ïö∞Î¶¨Í∞Ä testÎ™ÖÎ†πÏúºÎ°ú Ïã§ÌñâÏùÑ ÌïòÍ≤å ÎêòÎ©¥ NODE_ENVÎäî testÍ∞Ä Îê† Í±∞Îã§ 
  > npm run test:e2e   ‚úÖNODE_ENV = 'test'
  > envFilePath: '.env.test' Ïã§Ìñâ 
*/
/*#Ô∏è‚É£12.0 Subscriptions part One - Graphql Subscription ~ #Ô∏è‚É£12.1 Subscriptions part Two

  1.[GraphQL] subscripttionsÏùÄ resolverÏóêÏÑú 'Î≥ÄÍ≤ΩÏÇ¨Ìï≠'Ïù¥ÎÇò 'ÏóÖÎç∞Ïù¥Ìä∏'Î•º ÏàòÏã† Ìï† Ïàò ÏûàÍ≤å Ìï¥Ï§ÄÎã§

  2. [orders.resolver.ts] üìÑnpmjs.com/package/graphql-subscriptions
    @Subscription(returns => String) üîµ"Î™á Í∞ÄÏßÄ Í∑úÏπôÏù¥ ÏûàÎäîÎç∞ Í∑∏ Í∑úÏπôÏùÄ Ïö∞Î¶¨Í∞Ä Î≠ò return ÌïòÎäîÏßÄÏóê Îî∞Îùº Ï†ïÌï¥Ïßê"
    hotPotatos() {
      return pusub.asyncIterator(triggers: üîµÏö∞Î¶¨Í∞Ä Í∏∞Îã§Î¶¨Îäî Ïù¥Î≤§Ìä∏: "Ïù¥Î≤§Ìä∏Î•º Îì£Í≥† Ïã∂ÏúºÎ©¥ Ïù¥ SubscriptionÏì∞Î©¥ ÎêúÎã§"
    }

   3. 
     PubSubÏùÄ publish and subscribeÎ•º ÎßêÌïúÎã§  
      subscription{ üîµHTTP routeÎ•º Í±∞ÏπòÏßÄ ÏïäÍ≥† Web Socket routeÎ•º Í±∞ÏπòÍ≥† ÏûàÎã§
        hotPotatos
      }

   4. {
        "error": "Could not connect to websocket endpoint ‚úÖws://localhost:3000/graphql.
        Please check if the endpoint url is correct."
      }
      üîπws: ÌîÑÎ°úÌÜ†ÏΩú, Ïù¥Í≤ÉÏùÄ Real TimeÏùÑ Ï≤òÎ¶¨ÌïòÎäî 'Web Socket'ÏùÑ ÎßêÌïúÎã§ 
       ‚úÖWeb SocketÏùÑ ÌôúÏÑ±Ìôî Ìï¥ÏïºÌïúÎã§ 
       GraphQLModule.forRoot({
       ‚úÖinstallSubscriptionHandlers:true, ‚≠êÏÑúÎ≤ÑÍ∞Ä Ïõπ ÏÜåÏºì Í∏∞Îä•ÏùÑ Í∞ÄÏßÄÍ≤å ÎêúÎã§ 
       }),
       üî¥Ïõπ ÏÜåÏºìÏóêÎäî 'request'Í∞Ä ÏóÜÎã§
       üîµÏõπ ÏÜåÏºìÏóêÎäî 'conneection'Ïù¥ÎùºÎäî Í≤ÉÏù¥ ÏûàÎã§ 
         
    5. connectionÏùÄ 'context'ÏôÄ Í∞ôÏù¥ Ïò®Îã§  vs  requestÎäî x-jwt headerÍ∞Ä ÏûàÎã§ 
      üîπÏõπÏÜåÏºì: 'Connection'ÏùÄ Ïõπ ÏÜåÏºìÏù¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏôÄ ÏÑúÎ≤Ñ Í∞ÑÏùò Ïó∞Í≤∞ÏùÑ ÏÑ§Ï†ïÌïòÎ†§Í≥† Ìï† Îïå Î∞úÏÉùÌïúÎã§ 

     5-1) 
          [app.module.ts]
            context: ({req, connection}) => {
              if(req) {
                return { user: req['user'] };
              } else {
                return { potato: 'hot' }
            }


    5-2) guardÎäî 'HTTP'Ïù¥Îì† 'Ïõπ ÏÜåÏºì'Ïù¥Îì† Î™®Îì† 'graphQL resolver'Ïóê ÎåÄÌï¥ Ìò∏Ï∂ú ÎêúÎã§
         [auth.guard.ts]
            const gqlContext = GqlExecutionContext.create(context).getContext();
            console.log(gqlContext ) //üöß{photato: 'hot', req: undefined}    
    5-3) [app.modul.ts]
        üîµÏÇ¨Ïö©ÏûêÍ∞Ä Ïù∏Ï¶ùÎêòÏóàÎäîÏßÄ ÌôïÏù∏ÌïòÎäî Í≤ÉÏùÄ subscriptions ÏòµÏÖòÏóêÏÑú ÏßÄÏ†ïÌï† Ïàò ÏûàÎäî onConnectÏΩúÎ∞± Ìï®Ïàò ÎÇ¥ÏóêÏÑú ÏàòÌñâ ÎêòÏñ¥Ïïº ÌïúÎã§
        üîµonConnectÎäî Ï≤´ Î≤àÏß∏ Ïù∏ÏàòÎ°ú SubscriptionClient(‚úÖplayground-HTTPHeader?)Ïóê Ï†ÑÎã¨Îêú 'connectionParams'Î•º Î∞õÎäîÎã§
          üîπÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏: Í≤åÏûÑÌöåÏÇ¨, ÏÑúÎ≤Ñ(Ïª¥Ìì®ÌÑ∞)ÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏ > ÏÉàÎ°úÏö¥ Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏Î•º ÎÇ¥Î†§Î∞õÎäî Í≤ÉÏùÑ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏   
*/
/*#Ô∏è‚É£ dotenv & crossenv
   1. "start:dev": "cross-env NODE_ENV=dev nest start --watch",
      üöÄ.env.dev ÌååÏùºÏùÑ Ïã§ÌñâÏãúÌÇ®Îã§ > ‚ö°process.env.DB_HOST Îì± 
      üî¥.env.dev (Í∏∞Ï°¥)> .env.prod(ÌôïÏû•ÏûêÎ≥ÄÍ≤Ω) > üößConfig validation error: "DB_HOST" is required Îì±
*/
/*#Ô∏è‚É£13.2 Subscription Authentication part One 
1.üöß 'Web socket' - 'subscriptions-transport-ws' üöß
   GraphQLModule.forRoot({
      driver: ApolloDriver,
      autoSchemaFile: true,
      subscriptions: {
        //üö®graphql-ws Í∂åÏû•! üìÑhttps://docs.nestjs.com/graphql/subscriptions#subscriptions
        'subscriptions-transport-ws': {
          onConnect: (connectionParams) => {
          //console.log(connectionParams) //{"x-jwt":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywiaWF0IjoxNjY0OTM5MzM2fQ.BV5myZA10vef-xz-zZRQWRGyvLNUNsdotPLUI_tNS7M"}
          const authToken = connectionParams['x-jwt'];
          if(!authToken){
            throw new Error('Token is  not valid')
          }
          const token = authToken;
          return {token} 
          },
        },
      },
      context: ({ req, connection }) => ({ token: req.headers['x-jwt'] }),
    }), 

  #Ô∏è‚É£25.1 Subscription Setup
  üöß 'Web Socekt': 'graphql-ws'üöß
    +üìÑSoujiro-aÎãò: https://github.com/Soujiro-a/nuber-eats-backend/commit/ae04e5ac9a7acd7845cf7cbe02c72f73ce14806a 
    +üìÑNest JS docs: https://docs.nestjs.com/graphql/subscriptions#authentication-over-websockets  
    +üìÑAPOLLO docs:  https://www.apollographql.com/docs/react/data/subscriptions/#1-install-required-libraries

     ÌîÑÎ°†Ìä∏ ÏóîÎìú: npm install graphql-ws ÏÑ§Ïπò 
*/

@Module({
  imports: [ 
    ConfigModule.forRoot({
      isGlobal:true,
      envFilePath: process.env.NODE_ENV === 'dev' ? '.env.dev' : '.env.test',
      ignoreEnvFile: process.env.NODE_ENV === 'prod',
      validationSchema: Joi.object({
        NODE_ENV: Joi.string()
          .valid('dev', 'prod', 'test')
          .required(),
        DB_HOST: Joi.string().required(),
        DB_PORT: Joi.string().required(),
        DB_USERNAME: Joi.string().required(),
        DB_PASSWORD: Joi.string().required(),
        DB_NAME: Joi.string().required(),
        PRIVATE_KEY: Joi.string().required(),
        MAILGUN_API_KEY: Joi.string().required(),
        MAILGUN_DOMAIN_NAME: Joi.string().required(),
        MALIGUN_FROM_EMAIL: Joi.string().required(),
        AWS_ACCESS_KEY: Joi.string().required(),
        AWS_ACCESS_SECRET_KEY: Joi.string().required(),
      }),
    }),
    TypeOrmModule.forRoot({
      type: 'postgres',
      host: process.env.DB_HOST,
      port: +process.env.DB_PORT,
      username: process.env.DB_USERNAME,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_NAME,
      synchronize: process.env.NODE_ENV !== 'prod',
      logging: process.env.NODE_ENV !== 'prod' && process.env.NODE_ENV !== 'test',
      entities:[User, Verification, Restaurant, Category, Dish, Order, OrderItem, Payment ],
      
    }),
    GraphQLModule.forRoot({
      driver: ApolloDriver,
      autoSchemaFile: true,
      subscriptions: {
        'graphql-ws': {
          onConnect: (context: Context<any>) => {
          
          const {connectionParams, extra} = context;
          extra.token = connectionParams['x-jwt'] 
          },
        },
      },
      context: ({ req, extra}) => {
        //console.log(extra) 
        if(extra){
          return { token: extra.token }
        } else {
          return { token: req.headers['x-jwt']}
        }
      }
    }), 


    ScheduleModule.forRoot(),   
    JwtModule.forRoot({
      privateKey: process.env.PRIVATE_KEY
    }),

    MailModule.forRoot({
      apiKey: process.env.MAILGUN_API_KEY,
      domain: process.env.MAILGUN_DOMAIN_NAME,
      fromEmail: process.env.MALIGUN_FROM_EMAIL,

    }),
    AuthModule,
    UsersModule,
    RestaurantsModule,
    OrdersModule,
    CommonModule,
    PaymentModule,
    UploadsModule,
    
  ],
  controllers: [],
  providers: [],
})
/*#Ô∏è‚É£5.6 Middlewares in NestJS
1. ‚≠ê"JwtMiddlewareÎ•º forRoutes()Î•º ÌÜµÌï¥ÏÑú /graphql Í≤ΩÎ°ú(path)Ïóê methodÍ∞Ä POSTÏù∏ Í≤ΩÏö∞ÏóêÎßå Ï†ÅÏö© "
   ‚≠ê nestjsÏóêÏÑúÎäî Ïñ¥Îñ§ routesÏóê middlewareÎ•º Ï†ÅÏö©ÏãúÌÇ¨ÏßÄ ÏßÄÏ†ïÌï† ÏàòÍ∞Ä ÏûàÎã§  
  MiddlewareConsumer.apply(üîπJwtMiddleware)
  >üìÉmiddleware class/function(=üîπJwtMiddleware) be attached to the passed routes.
2.‚≠ê<Î™®Îì† routesÏóê Ï†ÅÏö©ÌïòÎäî Î∞©Î≤ï>
  export class AppModule implements NestModule{
    configure(consumer: MiddlewareConsumer) {
      consumer.apply(JwtMiddleware).forRoutes({
        path: '*'
        method: RequestMethod.ALL
      }) 
    }
  }    
3.‚≠ê</apiÎ•º Ï†úÏô∏ÌïòÍ≥† Ï†ÅÏö©>
export class AppModule implements NestModule{
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(JwtMiddleware).exclude({
      path:'/api',
      method: RequestMethod.ALL, 
    }) 
  }
}
4.‚≠ê<ÏùºÎ∞òÏ†Å ÏÇ¨Ïö©>
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(JwtMiddleware)
      .forRoutes({ path: '/graphql', method: RequestMethod.POST });
  }
}
*/
export class AppModule {}
