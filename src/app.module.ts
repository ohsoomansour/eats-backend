/* eslint-disable prettier/prettier */

/*#ï¸âƒ£1.0 Appllo Server Setup
 1.ì„¤ì¹˜: npm i @nestjs/graphql @nestjs/apollo graphql apollo-server-express
    > ì´í•´:  graphql & appllo server ê¸°ë°˜í•˜ì—¬ ì‘ë™ 
 2. AppModuleì€ main.tsë¡œ importë˜ëŠ” ìœ ì¼í•œ ëª¨ë“ˆ    
 3. forRoot
  - 'ë£¨íŠ¸ ëª¨ë“ˆ'ì„ ì„¤ì •í•˜ëŠ” ê²ƒ ì—¬ê¸°ì„œëŠ” â­GraphModuleì´ ì´ë‹¤ 
    > Error: Appllor Server requires either an existing 'schema', modules or 'typeDefs'
    > Errorì´ìœ : graphqlì´ dataì˜ shapeì„ ë¯¸ë¦¬ ì•Œê³  ìˆì–´ì•¼ í•˜ê¸° ë•Œë¬¸
        â­gql`
           (Schema Defination Language)
          1)query dataì— ëŒ€í•´ì„œë„ í•˜ë‚˜ì˜ ì–¸ì–´ë¥¼ ì“°ê³  dataì˜ shapeì„ ì„¤ëª…í•˜ëŠ” ë°ì—ë„ ê°™ì€ ì–¸ì–´ë¥¼ ì“´ë‹¤ëŠ” ê²ƒ  
          2)ìš°ë¦¬ dataì˜ typeì— ëŒ€í•´ graphqlí•œí…Œ ì„¤ëª…í•´ì£¼ê¸° ìœ„í•´ì„œ 
          3)Query root type must be provided.
          
  ğŸ”¹IDE(Integrated Development Environment): í”„ë¡œê·¸ë˜ë¨¸ê°€ ì½”ë“œë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê°œë°œí•˜ë„ë¡ ë•ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ì• í”Œë¦¬ì¼€ì´ì…˜        
  #ï¸âƒ£1.1 Our First Resolver
  1. The GraphQLModule can be configured to use Apollo server "ì•„í´ë¡œ ì„œë²„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•œë‹¤ "
  2. https://www.apollographql.com/docs/apollo-server/api/apollo-server
    > API Reference: apollo-server ì—ì„œ ì„¸íŒ… í™•ì¸

  3. Quick start - ğŸ”·Code first
   - GraphQLModule.forRoot<ApolloDriverConfig>({
    â­driver: ApolloDriver,
    â­autoSchemaFile: join(process.cwd(), 'src/schema.gql'),  "ìë™ìœ¼ë¡œ ë‚  ìœ„í•´ 'schema'ë¥¼ ìƒì„± í•´ì¤€ë‹¤ "
    }),                   


    > ğŸš¨Missing "driver" option > â­driver: ApolloDriver,
    > ğŸš¨ì—ëŸ¬ ë©”ì„¸ì§€: Query root type must be provided
      - Schema generation error (code-first approach)
      - ì›ì¸:
       [GraphQL > API Reference - ApploServer ì°¸ì¡°]
        Document or documents that represent your server's GraphQL schema
        ,generated by applying the gql tag to valid Schema Definition Language (SDL) strings. 
        ğŸ”¹const typeDefs = gql`
          type Query {}
        `
        ğŸ”¹const server = new ApolloServer({typeDefs, resolvers});
        â­ìš°ë¦¬ì˜ GraphQL ëª¨ë“ˆì´  Query root typeì™€ resolverë¥¼ ì°¾ê³  ìˆë‹¤ 
        > npx nest g mo restaurants 
        > [resaurants.module.ts] ìƒì„±ì´ ë ê±°ê³ 
          @Module({
          â­providers: [RestaurantResolver],
          })
          export class RestaurantsModule {}  
        > [restaurants.resolver.ts] íŒŒì¼ ì§ì ‘ ë§Œë“¤ê³  â­@Resolver & @Query ì‘ì„± 
        > [schema.gql]íŒŒì¼ ìƒì„± í›„ ì‚­ì œì‹œ, â­autoSchemaFile:true;
    4.http://localhost:3000/graphql 
      > playground & SCHEMAê°€ ìˆë‹¤ 
         
 */
/*#ï¸âƒ£2.0 TypeORM and PostgreSQL
  1. ğŸ›¸TypeScript & NesJSì—ì„œ DataBaseì™€ í†µì‹ í•˜ê¸° ìœ„í•´ì„œ > â­ORM ì‚¬ìš©
  2. typeorm.io/#/ > TYPE ORMì„ ì“°ë©´ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ì˜ ì¢‹ì€ ì ì„ ëª¨ë‘ ì´ìš©
  3. TypeORM: Object Relational Mapping ê°ì²´ ê´€ê³„ ë§¤í•‘ 
   > SQLë¬¸ì„ ì“°ëŠ” ëŒ€ì‹ ì— ì½”ë“œë¥¼ ì¨ì„œ ìƒí˜¸ì‘ìš©ì„ í•  ìˆ˜ ìˆë‹¤
   > íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ > TYPE ORM ğŸ›¸ ë°ì´í„°ë² ì´ìŠ¤ì™€ ìƒí˜¸ì‘ìš© 

  4.PostgreSQL: https://www.postgresql.org/ 
  ğŸ“„ 4-1)ì„¤ì¹˜
   > C:\Program Files\PostgreSQL\11 > pw:2848 > port:3000 
   > postgresql-12.12-1-windows-x64.exe --install_runtimes 0
   >â­PostgreSQL 11.2 ì„¤ì¹˜ë°©ë²• https://source-factory.tistory.com/22
   >â­PostgreSQL 11.2  https://get.enterprisedb.com/postgresql/postgresql-11.2-1-windows-x64.exe
   > ì„¤ì¹˜ê²½ë¡œ: C:\Program Files\PostgreSQL\11\data
   >  port:5432

  ğŸ“„ 4-2)â­ì„œë²„ì— ì—°ê²° ë°©ë²•
   > pgAdmin ì—´ê¸° >  > [Add New server]
      - â­[connection] > hostname: localhost > port:5432(default) > Maintenanace database: postgres(default) 
      - Username:postgres(default) 
      > password:284823
   > Databaseìš°í´ë¦­, Create > Database: ğŸ”¹nuber-eats > Owner: ohsoomansour
   > â­SQL: Create DATABASE "nuber-eats", OWNER = ohsoomansour 
   > ì‹¤í–‰ëœë‹¤ëŠ” ê²ƒë§Œ ì•Œê³  ë„˜ì–´ê°
   >

  5. TypeORM
   - ì˜ë¯¸: TypeScriptë¡œ ì‘ì„±ëœ ê´€ê³„í˜• ë§¤í¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ SQLì„ ì‘
   > docs.nestjs.com/techniques/database
   > npm > https://www.npmjs.com/package/typeorm
   > npm install typeorm --save
   > â­npm install reflect-metadata --save
   > npm install @types/node --save-dev
   > npm install pg --save
   > npm install --save @nestjs/typeorm typeorm pg
   > npm install typeorm --save
   > Install a database driver: npm install pg --save

  6. í”„ë¡œì íŠ¸ & ì™¸ë¶€DB(PostgreSQL) ì—°ê²°    
   - ì½”ë“œì— ì§ì ‘ì“°ê±°ë‚˜ ormconfig.jsonì´ë¼ëŠ” íŒŒì¼ì— ì“°ëŠ” ë°©ë²• 
   - port:  5432(PostgreSQL)
    
   - password: localhostë©´ ì•ˆì¨ë„ë¨, ohsoomansour(2848)
   - synchronize:true, "ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë„ˆì˜ ëª¨ë“ˆì˜ í˜„ì¬ìƒíƒœë¡œ ë§ˆì´ê·¸ë˜ì´ì…˜(ì´ë™) í•œë‹¤ëŠ” ëœ» "
   - logging: true, "ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ì§€ ì½˜ì†”ì— í‘œì‹œ" 
    > â­npm run start:dev "ì•„ë˜ì˜ SQLì½”ë“œ ë³´ì´ë©´ ì„±ê³µ"
    query: SELECT * FROM current_schema()
    query: SELECT version();
    query: START TRANSACTION
    query: SELECT * FROM "information_schema"."tables" WHERE "table_schema" = 'public' AND "table_name" = 'typeorm_metadata'
    query: COMMIT

  7. ğŸš¨Error: listen EADDRINUSE: address already in use :::3000 +5ms
   - ì´ë¯¸ 3000ë²ˆ í¬íŠ¸ê°€ ì‚¬ìš©ì¤‘ì´ë‹¤ 
   - í•´ê²°ë°©ì•ˆ1. ì„œë²„ë¥¼ ë‹¤ ë„ê±°ë‚˜ í•´ê²°ë°©ì•ˆ2.  ë°±ì•¤ë“œport: 4000 5000 8000 
  
   */
/*#ï¸âƒ£2.4 í™˜ê²½ë³€ìˆ˜ íŒŒì¼(.env)ì„ node.jsì—ì„œ ì´ìš©í•˜ëŠ” ë°©ë²•ì€
ğŸ“„TS(npm): https://www.npmjs.com/package/dotenv
> â­dotenvë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¡œë“œí•˜ëŠ”ë°
> [node.js] node.jsì—ì„œ ğŸ”¹'í™˜ê²½ë³€ìˆ˜'ì— ì ‘ê·¼í•  ë•ŒëŠ” ğŸ”¹'process.env'ë¼ëŠ” 'ë‚´ì¥ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´'ë¥¼ ì‚¬ìš© 
  - processëŠ” ì „ì—­ê°ì²´ ë³„ë„ë¡œ ì„í¬íŠ¸ ëª¨ë“ˆì´ ì—†ìœ¼ë©° ì–´í”Œë¦¬ì¼€ì´ì…˜ ì–´ë””ì—ì„œë“  ì ‘ê·¼ì´ ê°€ëŠ¥í•¨
  
ğŸ”·ì˜ˆì‹œ â­"db ëª¨ë“ˆì´ env.process ë¥¼ í†µí•´ í™˜ê²½ë³€ìˆ˜ ê°ì²´ë¥¼ ì–»ê³   >> ì„œë²„ì— ì—°ê²°"
  const db = require('db') 
   db.connect({
     host: process.env.DB_USER
     username: process.env.DB_USER,
     password: process.env.DB_PASS
       })
  *equire(): "ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜´"
  *connect() í•¨ìˆ˜ëŠ” ì„œë²„ì— ëŒ€í•œ ì—°ê²°ì„ ì„¤ì •í•˜ëŠ” ë° ì‚¬ìš©
  *í™˜ê²½ë³€ìˆ˜: ì–´ëŠ directoryì—ì„œë“ ì§€ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ í•  ìˆ˜ìˆê²Œ ë§Œë“¬ â€»https://velog.io/@psj0810/%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98%EB%9E%80

 ğŸ“„nestjsë°©ë²•: "ğŸ“configuration mudule ì´ë€ê±¸ ê°€ì§€ê³  ìˆìŒ" â€»https://docs.nestjs.com/techniques/configuration
 1. ì„¤ì¹˜: npm i --save @nestjs/config 
  - The @nestjs/config package internally uses dotenv
 2.ConfigModule.forRoot({
    ğŸ”¹isGlobal:true, "ìš°ë¦¬ appì˜ ì–´ë””ì„œë‚˜ 'config ëª¨ë“ˆ'ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ëŠ” ê±° "
    ğŸ”¹envFilePath: ".env",  "ìš°ë¦¬ íŒŒì¼ì—ì„œ .env íŒŒì¼ì„ ì½ëŠ”ë‹¤ "
    ğŸ”¹ignoreEnvFile: process.env.NODE_ENV === 'prod' "production í™˜ê²½ì¼ ë•ŒëŠ” configModuleì´ 'í™˜ê²½ë³€ìˆ˜ íŒŒì¼'ì„ ë¬´ì‹œ "
      > í™˜ê²½ë³€ìˆ˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì–»ì„ê±°ì„ 
    ğŸ”¹validationSchema:Joi.object({
        a: Joi.number().min(1).max(10).integer(),
        b: 'some string'
      })
      ğŸ“„docs:https://joi.dev/api/?v=17.7.0#object
  })
  > 
         
  > í™˜ê²½ì„ ì„¤ì •í•˜ë ¤ë©´ npm i cross-env 
   - â­cross-env íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ë©´ ë™ì ìœ¼ë¡œ process.env í™˜ê²½ë³€ìˆ˜(ê°€ìƒë³€ìˆ˜)ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤ (OSì— ê´€ê³„ì—†ì´)
  > [package.json] start:dev ì»¤ë§¨ë“œë¥¼ ì…ë ¥í•˜ë©´, .env.devë¡œ ì„¤ì •í•˜ê³ ì‹¶ë‹¤ 
                   testë‚˜ test:wathë¥¼ ì…ë ¥í•˜ë©´, .env.testë¡œ ì„¤ì •í•˜ê³  ì‹¶ë‹¤ 
                   start ì»¤ë§¨ë“œë¥¼ ì…ë ¥í•˜ë©´, env.proë¡œ ì„¤ì •í•˜ê³  ì‹¶ë‹¤ 

  > [package.json] "start:dev": "cross-env NODE_ENV=dev nest start --watch",
    - npm run start:dev (í„°ë¯¸ë„) -> "(ëª…ì‹œëœ)'cross-env'ë¥¼ ë¶ˆëŸ¬ì„œ NODE_ENVë¼ëŠ” â­í™˜ê²½ë³€ìˆ˜(ê°€ìƒë³€ìˆ˜)ë¥¼ devë¼ê³  ì§€ì •"
  
  
  #ï¸âƒ£ dotenv & cross-env
   1.ğŸ”·dotenv ì„¤ì¹˜: npm install dotenv --save  
     > Create .env file in the root of my project
       - DB_HOST = localhost
       - PRIVATE_KEY = 0bVoAzPLOmS1StzMkDzwjqrl1yTNWQwi
     >ğŸ”¹process.env.DB_HOST
       "NodeJS ì•±ì´ ë™ì‘í•  ë¦¬ëˆ…ìŠ¤/ìœ ë‹‰ìŠ¤ ì‹œìŠ¤í…œì˜ í™˜ê²½ë³€ìˆ˜ë¥¼ ì´ìš©í•˜ëŠ” ê²ƒ"

     > [.gitnore] íŒŒì¼ì— .envë¥¼ ì¶”ê°€ 
      # dotenv environment variable files
        .env
        .env.dev
        .env.test
     
     
   2.ğŸ”·cross-env: ğŸ“„The NODE_ENV environment variable will be set by cross-env
      [package.json]
       "start:dev": "cross-env NODE_ENV=dev nest start --watch", 
       "start": "cross-env NODE_ENV=production nest start",  

   3.[node.js, NODE_ENV ê°’ì„ ì„¤ì •]
    â­NODE_ENV(í™˜ê²½ë³€ìˆ˜)ëŠ” í˜„ì¬ ë‹¨ê³„ë¥¼ ì •í•´ì£¼ëŠ” 'ìƒìˆ˜'ì¼ë¿: devë‹¨ê³„ ? ìŠ¤í…Œì´ì§• ë‹¨ê³„ ? í”„ë¡œë•ì…˜ë‹¨ê³„ ? 
      > ê° í”„ë ˆì„ì›Œí¬(ë¼ì´ë¸ŒëŸ¬ë¦¬)ë§ˆë‹¤ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ìˆœì„œê°€ ê³µì‹ë¬¸ì„œì— ìˆìŒ 
        - OSê°€ windowì¼ ê²½ìš°, set NODE_ENV = production  
        - OSê°€ Mac OS X ê¸°ì¤€, export NODE_ENV = production
  */
/*#ï¸âƒ£2.6 Validating ConfigService
1. npm i joi
  > validationSchema: "ìŠ¤í‚¤ë§ˆì˜ ìœ íš¨ì„± í™•ì¸ì´ë¼ê³  ìƒê°í•˜ë©´ ë¨"
*/
/*#ï¸âƒ£3.3Recap
  â­TypeOrmModule.forRoot({ 
      entities: [Restaurant]
      logging: true  
    })
   > TypOrmModuleì´ Restaurant entityë¥¼ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì—' Restaurantì´ DB'ê°€ ë˜ëŠ” ê±°ë‹¤
   > logging: true "DBì—ì„œ ëŒì•„ê°€ëŠ” ëª¨ë“  ë¡œê·¸ë“¤ì„ í™•ì¸ "
*/
/*#ï¸âƒ£ğŸ“ƒforRoot: https://docs.nestjs.com/modules
  ğŸ”´1. GraphQLModule.forRoot ë©”ì„œë“œì— ì¸ìˆ˜ë¡œ contextë¥¼ ë„£ìœ¼ë©´ ì–´ë–»ê²Œ ì¸ì‹ì´ ë˜ëŠ” ê±´ê°€ìš” ?
          forRootë©”ì„œë“œì˜ ì´í•´ê°€ ë¶€ì¡±í•´ì„œ ì´í•´ê°€ ì˜ ì•ˆ ë˜ëŠ”ê±° ê°™ìŠµë‹ˆë‹¤
          GraphQLModule.forRoot({
          driver: ApolloDriver,
          autoSchemaFile: true,
          context:({ req }) => ({user: req['user'] })
        }),
2. ì•„ë‹ˆë©´ nestjsì˜ ë¬¸ë²• ê·¸ëŒ€ë¡œ ì´í•´ë¥¼ í•´ì•¼ í•˜ëŠ” ê±´ê°€ìš” ?
 >> âœ…nico:  Yes, this is how you configure a module on NestJS
*/
/*#ï¸âƒ£9.0 Setup part One
1. where do we set NODE_ENV as 'test' ? ğŸ“„https://jestjs.io/docs/en/environment-variables
 > Set to 'test' if it's not already set to something else.
2. ìš°ë¦¬ê°€ testëª…ë ¹ìœ¼ë¡œ ì‹¤í–‰ì„ í•˜ê²Œ ë˜ë©´ NODE_ENVëŠ” testê°€ ë  ê±°ë‹¤ 
  > npm run test:e2e   âœ…NODE_ENV = 'test'
  > envFilePath: '.env.test' ì‹¤í–‰ 
*/
/*#ï¸âƒ£12.0 Subscriptions part One - Graphql Subscription ~ #ï¸âƒ£12.1 Subscriptions part Two

  1.[GraphQL] subscripttionsì€ resolverì—ì„œ 'ë³€ê²½ì‚¬í•­'ì´ë‚˜ 'ì—…ë°ì´íŠ¸'ë¥¼ ìˆ˜ì‹  í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤

  2. [orders.resolver.ts] ğŸ“„npmjs.com/package/graphql-subscriptions
    @Subscription(returns => String) ğŸ”µ"ëª‡ ê°€ì§€ ê·œì¹™ì´ ìˆëŠ”ë° ê·¸ ê·œì¹™ì€ ìš°ë¦¬ê°€ ë­˜ return í•˜ëŠ”ì§€ì— ë”°ë¼ ì •í•´ì§"
    hotPotatos() {
      return pusub.asyncIterator(triggers: ğŸ”µìš°ë¦¬ê°€ ê¸°ë‹¤ë¦¬ëŠ” ì´ë²¤íŠ¸: "ì´ë²¤íŠ¸ë¥¼ ë“£ê³  ì‹¶ìœ¼ë©´ ì´ Subscriptionì“°ë©´ ëœë‹¤"
    }

   3. 
     PubSubì€ publish and subscribeë¥¼ ë§í•œë‹¤  
      subscription{ ğŸ”µHTTP routeë¥¼ ê±°ì¹˜ì§€ ì•Šê³  Web Socket routeë¥¼ ê±°ì¹˜ê³  ìˆë‹¤
        hotPotatos
      }

   4. {
        "error": "Could not connect to websocket endpoint âœ…ws://localhost:3000/graphql.
        Please check if the endpoint url is correct."
      }
      ğŸ”¹ws: í”„ë¡œí† ì½œ, ì´ê²ƒì€ Real Timeì„ ì²˜ë¦¬í•˜ëŠ” 'Web Socket'ì„ ë§í•œë‹¤ 
       âœ…Web Socketì„ í™œì„±í™” í•´ì•¼í•œë‹¤ 
       GraphQLModule.forRoot({
       âœ…installSubscriptionHandlers:true, â­ì„œë²„ê°€ ì›¹ ì†Œì¼“ ê¸°ëŠ¥ì„ ê°€ì§€ê²Œ ëœë‹¤ 
       }),
       ğŸ”´ì›¹ ì†Œì¼“ì—ëŠ” 'request'ê°€ ì—†ë‹¤
       ğŸ”µì›¹ ì†Œì¼“ì—ëŠ” 'conneection'ì´ë¼ëŠ” ê²ƒì´ ìˆë‹¤ 
         
    5. connectionì€ 'context'ì™€ ê°™ì´ ì˜¨ë‹¤  vs  requestëŠ” x-jwt headerê°€ ìˆë‹¤ 
      ğŸ”¹ì›¹ì†Œì¼“: 'Connection'ì€ ì›¹ ì†Œì¼“ì´ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ì˜ ì—°ê²°ì„ ì„¤ì •í•˜ë ¤ê³  í•  ë•Œ ë°œìƒí•œë‹¤ 

     5-1) 
          [app.module.ts]
            context: ({req, connection}) => {
              if(req) {
                return { user: req['user'] };
              } else {
                return { potato: 'hot' }
            }


    5-2) guardëŠ” 'HTTP'ì´ë“  'ì›¹ ì†Œì¼“'ì´ë“  ëª¨ë“  'graphQL resolver'ì— ëŒ€í•´ í˜¸ì¶œ ëœë‹¤
         [auth.guard.ts]
            const gqlContext = GqlExecutionContext.create(context).getContext();
            console.log(gqlContext ) //ğŸš§{photato: 'hot', req: undefined}    
    5-3) [app.modul.ts]
        ğŸ”µì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì€ subscriptions ì˜µì…˜ì—ì„œ ì§€ì •í•  ìˆ˜ ìˆëŠ” onConnectì½œë°± í•¨ìˆ˜ ë‚´ì—ì„œ ìˆ˜í–‰ ë˜ì–´ì•¼ í•œë‹¤
        ğŸ”µonConnectëŠ” ì²« ë²ˆì§¸ ì¸ìˆ˜ë¡œ SubscriptionClient(âœ…playground-HTTPHeader?)ì— ì „ë‹¬ëœ 'connectionParams'ë¥¼ ë°›ëŠ”ë‹¤
          ğŸ”¹í´ë¼ì´ì–¸íŠ¸: ê²Œì„íšŒì‚¬, ì„œë²„(ì»´í“¨í„°)ì—ì„œ ì—…ë°ì´íŠ¸ > ìƒˆë¡œìš´ ë²„ì „ ì—…ë°ì´íŠ¸ë¥¼ ë‚´ë ¤ë°›ëŠ” ê²ƒì„ í´ë¼ì´ì–¸íŠ¸   
*/
/*


*/
/*#ï¸âƒ£13.2 Subscription Authentication part One 
1.ğŸš§ 'Web socket' - 'subscriptions-transport-ws' ğŸš§
 1-1)GraphQLModule.forRoot({
      driver: ApolloDriver,
      autoSchemaFile: true,
      subscriptions: {
        //ğŸš¨graphql-ws ê¶Œì¥! ğŸ“„https://docs.nestjs.com/graphql/subscriptions#subscriptions
        'subscriptions-transport-ws': {
          onConnect: (connectionParams) => {
          //console.log(connectionParams) //{"x-jwt":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywiaWF0IjoxNjY0OTM5MzM2fQ.BV5myZA10vef-xz-zZRQWRGyvLNUNsdotPLUI_tNS7M"}
          const authToken = connectionParams['x-jwt'];
          if(!authToken){
            throw new Error('Token is  not valid')
          }
          const token = authToken;
          return {token} 
          },
        },
      },
      context: ({ req, connection }) => ({ token: req.headers['x-jwt'] }),
    }), 
     
  1-2) [orders.resolver.ts]
      @Subscription
      pendingOrders() {
        return this.puSub.asyncIterator(NEW_PENDING_ORDER)
      }

    [playground]
    subscription{
      pendingOrders{
        id
        customer{
          email
        }
        driver{
          email
        }
        total
        status
      }
    }

  1-3)[auth.guard.ts]
    const gqlContext = GqlExecutionContext.create(context).getContext();
    console.log(gqlContext)   
  âš¡{
      token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjUsImlhdCI6MTY3MTc4MjUwOH0.sU8iFXIkbZYFUoGyWSZxxsWmq-rbeX7Oc8renijkPAo'
     }

  2. GraphQLModule.forRoot<ApolloDriverConfig>({
      driver: ApolloDriver,
      autoSchemaFile: true,
      //ğŸš¨ì£¼ì˜ì‚¬í•­1:playgroundì—ì„œ graphql-wsë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ ë”°ë¼ì„œ subscriptionì´ ì•ˆë¨  
      subscriptions: {
        'graphql-ws': {
          onConnect: (context: Context<any>) => {
          //ğŸš¨ì£¼ì˜ì‚¬í•­2: ìœ„ 'subscriptions-transport-ws'ë¥¼ ì°¸ê³ í•˜ì—¬ í•´ì„ í•  ê²ƒâ—  
          const {connectionParams, extra} = context;
          
          extra.token = connectionParams['x-jwt'] 
          },
        },
      },
      context: ({ req, extra}) => {
        //console.log(extra)
        if(extra){
          return { token: extra.token }
        } else {
          return { token: req.headers['x-jwt']}
        }
        
      },

  #ï¸âƒ£25.1 Subscription Setup
  ğŸš§ 'Web Socekt': 'graphql-ws'ğŸš§
    +ğŸ“„Soujiro-aë‹˜: https://github.com/Soujiro-a/nuber-eats-backend/commit/ae04e5ac9a7acd7845cf7cbe02c72f73ce14806a 
    +ğŸ“„Nest JS docs: https://docs.nestjs.com/graphql/subscriptions#authentication-over-websockets  
    +ğŸ“„APOLLO docs:  https://www.apollographql.com/docs/react/data/subscriptions/#1-install-required-libraries

     í”„ë¡ íŠ¸ ì—”ë“œ: npm install graphql-ws ì„¤ì¹˜ 
*/
import { ApolloDriver, ApolloDriverConfig } from '@nestjs/apollo';
import * as Joi from 'joi';
import { Module } from '@nestjs/common';
import { GraphQLModule } from '@nestjs/graphql';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ConfigModule } from '@nestjs/config';
import { UsersModule } from './users/uers.module';
import { User } from './users/entities/user.entity';
import { JwtModule } from './jwt/jwt.module';
import { Verification } from './users/entities/verification.entity';
import { MailModule } from './mail/mail.module';
import { Restaurant } from './restaurants/entities/restaurant.entity';
import { Category } from './restaurants/entities/category.entity';
import { RestaurantsModule } from './restaurants/restaurants.module';
import { AuthModule } from './auth/auth.module';
import { Dish } from './restaurants/entities/dish.entity';
import { OrdersModule } from './orders/orders.module';
import { Order } from './orders/entities/order.entity';
import { OrderItem } from './orders/entities/order-item.entity';
import { CommonModule } from './common/common.module';
import { PaymentModule } from './payment/payment.module';
import { Payment } from './payment/entities/payment.entity';
import { ScheduleModule } from '@nestjs/schedule';
import { UploadsModule } from './uploads/uploads.module';
import { Context } from 'apollo-server-core';

@Module({
  imports: [ 
    ConfigModule.forRoot({
      isGlobal:true,
      envFilePath: process.env.NODE_ENV === 'dev' ? '.env.dev' : '.env.test',
      ignoreEnvFile: process.env.NODE_ENV === 'production',
      validationSchema: Joi.object({
        NODE_ENV: Joi.string()
          .valid('dev','production', 'test' )
          .required(),
        DB_HOST: Joi.string(),
        DB_PORT: Joi.string(),
        DB_PASSWORD: Joi.string(),
        DB_USERNAME: Joi.string(),
        DB_NAME: Joi.string(),
        PRIVATE_KEY: Joi.string(),
        MAILGUN_API_KEY: Joi.string().required(),
        MAILGUN_DOMAIN_NAME: Joi.string().required(),
        MALIGUN_FROM_EMAIL: Joi.string().required(),
        AWS_ACCESS_KEY: Joi.string().required(),
        AWS_ACCESS_SECRET_KEY: Joi.string().required(),
      }),
      
    }),
    TypeOrmModule.forRoot({
      type: 'postgres',
      ...(process.env.DATABASE_URL
        ? { url: process.env.DATABASE_URL}
        : {
            host: process.env.DB_HOST,
            port: +process.env.DB_PORT,
            username: process.env.DB_USERNAME,
            password: process.env.DB_PASSWORD,
            database: process.env.DB_NAME,
          }  
        ),
      synchronize: false,
      logging: process.env.NODE_ENV !== 'production' && process.env.NODE_ENV !== 'test',
      entities:[User, Verification, Restaurant, Category, Dish, Order, OrderItem, Payment ],
      
    }),

    GraphQLModule.forRoot<ApolloDriverConfig>({
      driver: ApolloDriver,
      autoSchemaFile: true,
      //ğŸš¨ì£¼ì˜ì‚¬í•­1:playgroundì—ì„œ graphql-wsë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ ë”°ë¼ì„œ subscriptionì´ ì•ˆë¨  
      subscriptions: {
        'graphql-ws': {
          onConnect: (context: Context<any>) => {
          //ğŸš¨ì£¼ì˜ì‚¬í•­2: ìœ„ 'subscriptions-transport-ws'ë¥¼ ì°¸ê³ í•˜ì—¬ í•´ì„ í•  ê²ƒâ—  
          const {connectionParams, extra} = context;
          
          extra.token = connectionParams['x-jwt'] 
          },
        },
      },
      context: ({ req, extra}) => {
        //console.log(extra)
        if(extra){
          return { token: extra.token }
        } else {
          return { token: req.headers['x-jwt']}
        }
        
      },
    }), 
  

    ScheduleModule.forRoot(),   
    JwtModule.forRoot({
      privateKey: process.env.PRIVATE_KEY
      
    }),

    MailModule.forRoot({
      apiKey: process.env.MAILGUN_API_KEY,
      domain: process.env.MAILGUN_DOMAIN_NAME,
      fromEmail: process.env.MALIGUN_FROM_EMAIL,

    }),
    AuthModule,
    UsersModule,
    RestaurantsModule,
    OrdersModule,
    CommonModule,
    PaymentModule,
    UploadsModule,
    
  ],
  controllers: [],
  providers: [],
})

export class AppModule {}

/*#ï¸âƒ£5.6 Middlewares in NestJS
1. â­"JwtMiddlewareë¥¼ forRoutes()ë¥¼ í†µí•´ì„œ /graphql ê²½ë¡œ(path)ì— methodê°€ POSTì¸ ê²½ìš°ì—ë§Œ ì ìš© "
   â­ nestjsì—ì„œëŠ” ì–´ë–¤ routesì— middlewareë¥¼ ì ìš©ì‹œí‚¬ì§€ ì§€ì •í•  ìˆ˜ê°€ ìˆë‹¤  
  MiddlewareConsumer.apply(ğŸ”¹JwtMiddleware)
  >ğŸ“ƒmiddleware class/function(=ğŸ”¹JwtMiddleware) be attached to the passed routes.
2.â­<ëª¨ë“  routesì— ì ìš©í•˜ëŠ” ë°©ë²•>
  export class AppModule implements NestModule{
    configure(consumer: MiddlewareConsumer) {
      consumer.apply(JwtMiddleware).forRoutes({
        path: '*'
        method: RequestMethod.ALL
      }) 
    }
  }
  ğŸ”¹@    
3.â­</apië¥¼ ì œì™¸í•˜ê³  ì ìš©>
export class AppModule implements NestModule{
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(JwtMiddleware).exclude({
      path:'/api',
      method: RequestMethod.ALL, 
    }) 
  }
}
4.â­<ì¼ë°˜ì  ì‚¬ìš©>
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(JwtMiddleware)
      .forRoutes({ path: '/graphql', method: RequestMethod.POST });
  }
}
*/
